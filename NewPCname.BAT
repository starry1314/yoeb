@echo off
setlocal

:: === z查是否橄到y管理T，不是就提升 ===
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo 需要系y管理T嘞蓿正在L提升...
    powershell -NoProfile -Command "Start-Process '%~f0' -Verb RunAs"
    exit /b
)

set "inifile=C:\IOT\setnb.ini"
set "psfile=%temp%\pc_rename.ps1"

if not exist "%inifile%" (
    echo 找不到 %inifile%
    pause
    exit /b
)

:: === 一行一行a生 PowerShell _本，避免 ( ) 解析} ===
> "%psfile%"  echo $ini = '%inifile%'
>>"%psfile%" echo if (-not (Test-Path $ini^)) { Write-Host "找不到 ini n案：$ini"; exit 1 }
>>"%psfile%" echo $line = (Get-Content $ini^) ^| Where-Object { $_ -match '^\s*nob=' } ^| Select-Object -First 1
>>"%psfile%" echo if (-not $line^) { Write-Host "找不到 nob= @一行"; exit 1 }
>>"%psfile%" echo $n = ($line -replace '^\s*nob=','').Trim()
>>"%psfile%" echo if (-not $n^) { Write-Host "nob 值榭"; exit 1 }
>>"%psfile%" echo if ($n.Length -lt 2^) { $n = '0' + $n }
>>"%psfile%" echo if ($n.Length -gt 2^) { $n = $n.Substring($n.Length-2, 2^) }
>>"%psfile%" echo $newName = 'D' + $n
>>"%psfile%" echo $cs = Get-CimInstance Win32_ComputerSystem
>>"%psfile%" echo $curName = $cs.Name
>>"%psfile%" echo Write-Host "目前名Q：" $curName
>>"%psfile%" echo Write-Host "目嗣Q：" $newName
>>"%psfile%" echo if ($curName -eq $newName^) {
>>"%psfile%" echo ^    Write-Host "名Q相同 → 不更、不重_C"
>>"%psfile%" echo ^    exit 0
>>"%psfile%" echo }
>>"%psfile%" echo Write-Host "正在更名QK重_C..."
>>"%psfile%" echo Rename-Computer -NewName $newName -Force -Restart

:: === 绦 PowerShell _本 ===
powershell -NoProfile -ExecutionPolicy Bypass -File "%psfile%"

:: 清理捍n
del "%psfile%" >nul 2>&1

endlocal
exit /b
